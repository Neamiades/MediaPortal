@using MediaService.PL.Models.ObjectViewModels.DirectoryViewModels

@using MediaService.PL.Models.ObjectViewModels.FileViewModels
@using MediaService.BLL.DTO
@using MediaService.PL.Models.ObjectViewModels.DirectoryViewModels
@using MediaService.PL.Models.ObjectViewModels.FileViewModels
﻿@model DirectoryEntryDto
@{
    ViewBag.Title = "Home Page";
}

<div class="container indexMenu">
    <div class="row">
        <div class="col-xs-4">

            <input type="search" placeholder="Поиск файлов" class="custom-search-input" />

        </div>
        <div class="col-xs-4">
            <h2 class="indexTitle text-center">LuxStorage</h2>
        </div>
        <div class="col-xs-4">
            @Html.Partial("_LoginPartial")
        </div>
    </div>
</div>
<hr />
<div class="row customNav">
    <div class="col-xs-7">
        <p class="customBreadcrumb">Мои файлы</p>
    </div>
    <div class="col-xs-5">
        <div>

            <a class="pull-right" href="#">
                <img src="~/fonts/icons-buttons/tile.svg" id="tileImg" />
            </a>
            <a class="pull-right" href="#">
                <img src="~/fonts/icons-buttons/list.svg" id="listImg" />
            </a>
        </div>
        <img src="~/fonts/icons-buttons/next.svg" class="pull-right" id="dropdownImg" />
        <a class="pull-right btnLink" href="http://example.com" id="navbarDropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            По дате создания
        </a>


        <ul class="dropdown-menu dropdown-menu-right pull-right" aria-labelledby="navbarDropdownMenuLink">
            <li>
                <a class="dropdown-item" href="#">По дате добавления</a>
            </li>
            <li>
                <a class="dropdown-item" href="#">По размеру</a>
            </li>
</ul>
        
        <a class="pull-right btnLink" href="#">Настройки доступа </a>
</div>
</div>

           
      
           

<div class="row dirListView">
    <div class="col-xs-9">
        <div class="row folderList">
            <div id='directories'></div>
        </div>
        <div class="row filesList">
            <div id='files'></div>
        </div>
    </div>
    <div class="col-xs-3">
        <div id = "dirListMenu">
            <a href="#uploadFileModal" class="btn btn-primary  uploadFileBtn pull-right" rel="modal:open">Загрузить файл</a>
            <div id="uploadFileModal" style="display:none">
                @{Html.RenderPartial("~/Views/File/_UploadFiles.cshtml", new UploadFilesViewModel { ParentId = Model.Id });}
            </div>
            
         
            <a href="#createDirModal" class="btn btn-primary  createDirBtn pull-right" rel="modal:open">Создать папку</a>
            <div id="createDirModal" style="display:none">
                @{Html.RenderPartial("~/Views/Directory/_CreateDirectory.cshtml", new CreateDirectoryViewModel { ParentId = Model.Id });}
            </div>
        </div>
    </div>

</div>

@using (Ajax.BeginForm("UploadFiles", "File", null, new AjaxOptions { UpdateTargetId = "files", HttpMethod = "POST" }, new { enctype = "multipart/form-data" }))
{
    @Html.AntiForgeryToken()

    <div class="form-horizontal">
        @Html.ValidationSummary(true, "", new { @class = "text-danger" })
        @Html.Hidden("ParentId", Model.ParentId as Guid?)
        <div class="form-group">
            <div class="col-md-offset-2 col-md-10">
                <input type="file" id="FileUpload" multiple />
            </div>
        </div>
        <div class="form-group">
            <div class="col-md-offset-2 col-md-10">
                <input type="button" id="btnUpload" value="Upload Files" />
            </div>
        </div>
    </div>
}


@*todo: В идеале от этого нужно избавиться, а верхняя форма должна работать.*@
@*А еще лучше, чтобы все папко/файловые действия были в их вьюхах, а на этой вызывать только Index()*@
<input type="file" id="FileUpload" multiple />
<input type="button" id="btnUpload" value="Upload Files" />



@section Scripts {

    <script>
        $.ajax({
            url: '@Url.Action("DirectoriesList", "Directory", new {parentId = Model.Id})',
            type: "GET",
            contentType: "text/html; charset=utf-8",
            success: function(data) {
                $('#directories').html(data);
            }
        });

        $.ajax({
            url: '@Url.Action("FilesList", "File", new {parentId = Model.Id})',
            type: "GET",
            contentType: "text/html; charset=utf-8",
            success: function(data) {
                $('#files').html(data);
            }
        });
        //$(function(){
        //    $(document).ajaxStart(function () {
        //    //show a progress modal of your choosing
        //        window.showProgressModal('loading');
        //    });
        //    $(document).ajaxStop(function () {
        //    //hide it
        //        window.hideProgressModal();
        //    });

        //    $.ajax({
        //        url: '/Home/DirectoriesList',
        //        dataType: 'html',
        //        success: function(data) {
        //            $('#directories').html(data);
        //        }
        //    });
        //});

    </script>
    <script>
        $(document).ready(function() {
            $('#btnUpload').click(function() {

                // Checking whether FormData is available in browser  
                if (window.FormData !== undefined) {

                    var fileUpload = $("#FileUpload").get(0);
                    var files = fileUpload.files;
                    // Create FormData object  
                    var fileData = new FormData();

                    // Looping over all files and add it to FormData object  
                    for (var i = 0; i < files.length; i++) {
                        fileData.append(files[i].name, files[i]);
                    }
                    //files[1].creationTime
                    // Adding one more key to FormData object
                    //fileData.append('folderId', @Model.Id);

                    $.ajax({
                        url: '/File/UploadFiles?parentId=@Model.Id',
                        type: "POST",
                        contentType: false, // Not to set any content header
                        processData: false, // Not to process data
                        data: fileData,
                        success: function(data) {
                            //todo: Think about what to do after upload
                            $('#files').html(data);
                        },
                        error: function(err) {
                            alert(err.statusText + "BadLuck");
                        }
                    });
                } else {
                    alert("FormData is not supported.");
                }
            });
        });
    </script>
}